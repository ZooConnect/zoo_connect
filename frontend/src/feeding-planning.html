<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - Zoo Connect</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .dashboard-wrapper {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-intro {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .task-card {
            background: white;
            border-radius: 18px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            border-left: 6px solid #2d6a4f;
            position: relative;
        }

        /* --- MODAL FIXES --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(27, 67, 50, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 480px;
            /* Prevents overflowing the screen */
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <header class="top-bar">
        <a href="index.html" class="logo">Zoo Connect ðŸŒ¿</a>
        <nav class="auth-links">
            <a href="index.html">Main Page</a>
            <button onclick="logout()" class="login-link" style="border:none; cursor:pointer;">Logout</button>
        </nav>
    </header>

    <div class="dashboard-wrapper">
        <div class="page-intro">
            <div>
                <h1>Feeding Schedule</h1>
                <p style="color: #666;">Track and manage daily nutrition.</p>
            </div>
            <button class="btn-explore" onclick="openModal()">+ New Task</button>
        </div>
        <div id="tasksContainer" class="tasks-grid"></div>
    </div>

    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px; color: #2d6a4f;">Add Feeding Task</h2>
            <form id="scheduleForm">
                <div class="input-group">
                    <label>Resident Animal</label>
                    <select id="animalSelect" required>
                        <option value="">Loading animals...</option>
                    </select>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>Assigned Staff Member</label>
                    <select id="staffSelect" required>
                        <option value="">Loading staff...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="input-group">
                        <label>Time</label>
                        <input type="time" id="feedingTime" required>
                    </div>
                    <div class="input-group">
                        <label>Food Type</label>
                        <input type="text" id="foodType" placeholder="e.g. Meat" required>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit"
                        style="flex:2; background:#2d6a4f; color:white; border:none; padding:14px; border-radius:12px; cursor:pointer; font-weight:bold;">Save</button>
                    <button type="button" onclick="closeModal()"
                        style="flex:1; background:#f4f4f4; color:#666; border:none; padding:14px; border-radius:12px; cursor:pointer;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function loadPlanning() {
            try {
                const res = await fetch('/api/admin/feeding-schedules', { credentials: 'include' });
                if (!res.ok) {
                    console.error('Failed to load feeding schedules', res.status);
                    document.getElementById('tasksContainer').innerHTML = '<p style="color:#d32f2f;">Unable to load feeding schedules.</p>';
                    return;
                }

                const responseData = await res.json();
                
                // Extract data from response - it could be array or object with message
                let data;
                if (Array.isArray(responseData)) {
                    data = responseData;
                } else if (responseData && typeof responseData === 'object') {
                    // Filter out the message key and collect all objects with _id or id
                    data = Object.keys(responseData)
                        .filter(key => key !== 'message')
                        .map(key => responseData[key])
                        .filter(v => v && typeof v === 'object' && (v._id || v.id));
                    if (data.length === 0) data = []; // if no valid items found
                }

                const container = document.getElementById('tasksContainer');

                if (!data || data.length === 0) {
                    container.innerHTML = '<p>No tasks found.</p>';
                    return;
                }

                container.innerHTML = data.map(item => `
                    <div class="task-card">
                        <h3 class="animal-name">${item.animalId?.name || 'Unknown'}</h3>
                        <p>Time: ${item.feedingTime || 'TBD'}</p>
                        <p>Staff: ${item.staffId?.name || 'Unassigned'}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('tasksContainer').innerHTML = '<p style="color:#d32f2f;">Error loading feeding schedules.</p>';
            }
        }

        async function openModal() {
            document.getElementById('addScheduleModal').classList.add('modal-active');
            try {
                // Fetch Animals
                const resAnimals = await fetch('/api/animals', { credentials: 'include' });
                const animalsSelect = document.getElementById('animalSelect');
                if (!resAnimals.ok) {
                    console.error('Failed to load animals', resAnimals.status, resAnimals.statusText);
                    animalsSelect.innerHTML = '<option value="">Error loading animals</option>';
                } else {
                    const animalsData = await resAnimals.json();
                    console.log('Animals data received:', animalsData);
                    let animals;
                    if (Array.isArray(animalsData)) {
                        animals = animalsData;
                    } else if (animalsData && typeof animalsData === 'object') {
                        animals = Object.keys(animalsData)
                            .filter(key => key !== 'message')
                            .map(key => animalsData[key])
                            .filter(v => v && typeof v === 'object' && (v._id || v.id));
                    }
                    console.log('Parsed animals:', animals);
                    if (animals && animals.length === 0) {
                        animalsSelect.innerHTML = '<option value="">No animals found</option>';
                    } else if (animals) {
                        animalsSelect.innerHTML = animals.map(a =>
                            `<option value="${a._id || a.id}">${a.name} (${a.species || ''})</option>`).join('');
                    }
                }

                // Fetch Staff from admin endpoint with role=staff filter
                const resStaff = await fetch('/api/admin/users?role=staff', { credentials: 'include' });
                const staffSelect = document.getElementById('staffSelect');
                if (!resStaff.ok) {
                    console.error('Failed to load staff', resStaff.status, resStaff.statusText);
                    staffSelect.innerHTML = '<option value="">Error loading staff</option>';
                } else {
                    const staffData = await resStaff.json();
                    console.log('Staff data received:', staffData);
                    let staff;
                    if (Array.isArray(staffData)) {
                        staff = staffData;
                    } else if (staffData && typeof staffData === 'object') {
                        staff = Object.keys(staffData)
                            .filter(key => key !== 'message')
                            .map(key => staffData[key])
                            .filter(v => v && typeof v === 'object' && (v._id || v.id));
                    }
                    console.log('Parsed staff:', staff);

                    if (staff && staff.length > 0) {
                        staffSelect.innerHTML = staff.map(s =>
                            `<option value="${s._id || s.id}">${s.name}</option>`).join('');
                    } else {
                        staffSelect.innerHTML = '<option value="">No staff found</option>';
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('staffSelect').innerHTML = '<option value="">Error loading staff</option>';
            }
        }

        function closeModal() { document.getElementById('addScheduleModal').classList.remove('modal-active'); }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        document.getElementById('scheduleForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = {
                    animalId: document.getElementById('animalSelect').value,
                    staffId: document.getElementById('staffSelect').value,
                    feedingTime: document.getElementById('feedingTime').value,
                    foodType: document.getElementById('foodType').value
                };

                const res = await fetch('/api/admin/feeding-schedules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (!res.ok) {
                    alert('Error creating feeding schedule');
                    return;
                }

                closeModal();
                document.getElementById('scheduleForm').reset();
                loadPlanning();
            } catch (err) {
                console.error(err);
                alert('Error creating feeding schedule');
            }
        });

        window.onload = loadPlanning;
    </script>
</body>

</html>
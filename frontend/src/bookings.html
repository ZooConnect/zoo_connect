<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bookings - Zoo Connect</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bookings.css">
</head>

<body>
  <header class="top-bar">
    <a href="index.html" class="logo">Zoo Connect ðŸŒ¿</a>
    <nav class="auth-links">
      <a href="index.html">Home</a>
      <a href="profile.html">Profile</a>
      <button onclick="logout()" class="login-link" style="background:none;border:none;color:white;cursor:pointer;">
        Logout
      </button>
    </nav>
  </header>

  <main class="bookings-wrapper">
    <header class="explore-header">
      <h1>My Bookings</h1>
      <p>Review and manage your upcoming event tickets</p>
    </header>

    <div id="bookingsList">
      <div class="booking-card">
        <p>Loading your tickets...</p>
      </div>
    </div>
  </main>

  <script>
    async function fetchBookings() {
      try {
        const res = await fetch('/api/bookings', { credentials: 'include' });

        if (res.status === 401) {
          window.location.href = 'login.html';
          return;
        }

        const responseData = await res.json();
        console.log('[bookings] Response data:', responseData);

        // Parse response: handle both array format and spread-object format
        let bookings = [];
        if (Array.isArray(responseData)) {
          bookings = responseData;
        } else if (responseData && typeof responseData === 'object') {
          // Backend spreads data as { message: '...', 0: {...}, 1: {...}, ... }
          bookings = Object.keys(responseData)
            .filter(k => k !== 'message')
            .map(k => responseData[k])
            .filter(v => v && typeof v === 'object' && v._id);
        }

        console.log('[bookings] Parsed bookings:', bookings);
        const container = document.getElementById('bookingsList');

        if (!bookings || bookings.length === 0) {
          container.innerHTML = `
            <div class="booking-card">
              <p>No bookings found.
                <a href="events.html" style="color:#2d6a4f;font-weight:bold;">
                  Book an event now!
                </a>
              </p>
            </div>`;
          return;
        }

        container.innerHTML = bookings.map(b => {
          const event = b.eventId || {};
          const status = (b.status || 'unknown').toLowerCase();

          let eventDateStr = 'TBD';
          if (event.start_date) {
            const d = new Date(event.start_date);
            if (!isNaN(d)) eventDateStr = d.toLocaleDateString();
          }

          let bookingDateStr = 'TBD';
          if (b.bookingDate) {
            const bd = new Date(b.bookingDate);
            if (!isNaN(bd)) bookingDateStr = bd.toLocaleDateString();
          }

          const isActive = status === 'active';
          const statusClass = isActive ? 'status-active' : 'status-cancelled';

          return `
          <div class="booking-card">
            <div class="booking-header">
              <h2>${event.title || 'Event'}</h2>
              <span class="${statusClass}">
                ${status.toUpperCase()}
              </span>
            </div>

            <div class="info-line">
              <strong>Date</strong>
              <span>${eventDateStr}</span>
            </div>

            <div class="info-line">
              <strong>Location</strong>
              <span>${event.location || 'Zoo Main Entrance'}</span>
            </div>

            <div class="info-line">
              <strong>Tickets</strong>
              <span>${b.quantity || 0} person(s)</span>
            </div>

            <div class="info-line">
              <strong>Booking Date</strong>
              <span>${bookingDateStr}</span>
            </div>

            ${isActive ? `<button onclick="cancelBooking('${b._id}')" class="btn-cancel">Cancel Reservation</button>` : ''}
          </div>
        `;
        }).join('');
      } catch (err) {
        console.error('[bookings] Error:', err);
        document.getElementById('bookingsList').innerHTML =
          '<div class="booking-card"><p style="color:red;">Server error.</p></div>';
      }
    }

    async function cancelBooking(id) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;

      const res = await fetch(`/api/bookings/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (res.ok) fetchBookings();
      else alert('Cancellation failed');
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      window.location.href = 'login.html';
    }

    window.onload = fetchBookings;
  </script>
</body>

</html>
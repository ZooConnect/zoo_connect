<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Zoo Connect</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profile.css">
</head>

<body>

    <header class="top-bar">
        <a href="index.html" class="logo">Zoo Connect ðŸŒ¿</a>
        <nav class="auth-links">
            <a href="index.html">Home</a>
            <button onclick="logout()" class="login-link" style="border:none; cursor:pointer;">Logout</button>
        </nav>
    </header>

    <main class="profile-wrapper">
        <header class="explore-header" style="padding: 20px 0;">
            <h1>My Profile</h1>
            <p>View and update your personal information</p>
        </header>

        <section class="info-card">
            <h2 style="color: #2d6a4f; margin-bottom: 20px;">Personal Information</h2>
            <div class="info-line"><strong>Name :</strong> <span id="displayName">Loading...</span></div>
            <div class="info-line"><strong>Email :</strong> <span id="displayEmail">Loading...</span></div>
            <div class="info-line"><strong>Membership :</strong> <span id="displayMembershipType">-</span></div>
            <div class="info-line"><strong>Status :</strong> <span id="displayMembershipStatus">-</span></div>
        </section>

        <section class="auth-container" style="max-width: 100%;">
            <h2 style="color: #2d6a4f; margin-bottom: 20px;">Update Profile</h2>
            <form id="profileForm">
                <div class="input-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="input-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="input-group">
                    <label for="newPassword">New Password (optional)</label>
                    <input type="password" id="newPassword" name="newPassword" minlength="8">
                </div>
                <div id="errorMessage" class="error-message"></div>
                <div id="message" class="success-message"></div>
                <button type="submit" id="submitButton" class="signup-link"
                    style="border:none; cursor:pointer; margin-top: 10px;">Update Information</button>
            </form>
        </section>
    </main>

    <script>
        // VÃ©rifie la session cÃ´tÃ© serveur en envoyant les cookies (credentials: 'include')
        async function fetchProfile() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });

                if (!res.ok) {
                    if (res.status === 401) window.location.href = 'login.html';
                    throw new Error('Failed to fetch profile');
                }

                const user = await res.json();
                document.getElementById('displayName').textContent = user.name || '-';
                document.getElementById('displayEmail').textContent = user.email || '-';
                document.getElementById('displayMembershipType').textContent = user.membershipType || '-';
                document.getElementById('displayMembershipStatus').textContent = user.membershipStatus || '-';
                document.getElementById('name').value = user.name || '';
                document.getElementById('email').value = user.email || '';
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value
            };
            const pwd = document.getElementById('newPassword').value;
            if (pwd) payload.password = pwd;

            try {
                const res = await fetch('/api/auth/me', {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    document.getElementById('message').textContent = 'Profile updated!';
                    fetchProfile();
                } else if (res.status === 401) {
                    window.location.href = 'login.html';
                } else {
                    document.getElementById('errorMessage').textContent = 'Update failed.';
                }
            } catch (err) {
                document.getElementById('errorMessage').textContent = 'Network error.';
            }
        });

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {
                console.error('Logout request failed', err);
            }
            window.location.href = 'login.html';
        }

        window.onload = fetchProfile;
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zoo Events - Planifiez votre visite</title>
  <link rel="stylesheet" href="css/events.css">
</head>

<body>
  <div id="alert"></div>

  <div class="container">
    <header>
      <h1>Discover the Zoo differently ğŸ¦</h1>
      <p>Activities of the day and events to come</p>
    </header>

    <div class="filters-section">
      <div class="filter-group">
        <label>Date</label>
        <input type="date" id="dateFilter">
      </div>

      <div class="filter-group">
        <label>Type</label>
        <select id="typeFilter">
          <option value="">All activities</option>
          <option value="feeding">Feeding</option>
          <option value="show">Show</option>
          <option value="tour">Guided Tour</option>
        </select>
      </div>

      <button class="btn" style="background:#1b4332;color:white;" onclick="loadEventsFromUI()">
        Filter
      </button>
    </div>

    <div id="eventsContainer" class="events-grid"></div>
  </div>

  <script>
    async function loadEvents(filters = {}) {
      const container = document.getElementById('eventsContainer');

      try {
        const params = new URLSearchParams(filters).toString();
        const res = await fetch(`/api/events${params ? '?' + params : ''}`);
        const data = await res.json();

        const events = Object.values(data).filter(e => e && (e._id || e.id));

        if (!events.length) {
          container.innerHTML =
            "<p style='color:white;text-align:center;grid-column:1/-1;padding:50px;'>No events found.</p>";
          return;
        }

        container.innerHTML = events.map(event => {
          const d = new Date(event.start_date);
          const time = isNaN(d) ? "--:--" : d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
          const date = isNaN(d) ? "Unknown date" : d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

          return `
            <article class="event-card">
              <div class="event-header">
                <span class="event-type">${event.type || 'Event'}</span>
                <h3>${event.title}</h3>
              </div>

              <div class="event-body">
                <div class="event-date">ğŸ•’ ${time} | ğŸ“… ${date}</div>
                <p>${event.description}</p>
                <div class="event-location">ğŸ“ ${event.location || 'Zoo Central'}</div>
              </div>

              <div class="event-footer">
                <a href="/images/zoo-map.jpg" target="_blank" class="map-link">ğŸ—ºï¸ View map</a>
                <button class="btn btn-primary"
                  onclick="handleBooking('${event._id || event.id}')">Book</button>
              </div>
            </article>
          `;
        }).join('');

      } catch (err) {
        container.innerHTML =
          "<p style='color:#ffcccb;text-align:center;grid-column:1/-1;'>Error loading events.</p>";
      }
    }

    async function handleBooking(eventId) {
      const qtyStr = prompt('How many tickets?', '1');
      if (qtyStr === null) return;

      const quantity = Math.max(1, parseInt(qtyStr, 10) || 1);

      try {
        const res = await fetch('/api/bookings', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eventId, quantity })
        });

        if (res.status === 401) {
          showAlert("You must be logged in.", "error");
          setTimeout(() => location.href = "login.html", 1200);
          return;
        }

        if (res.ok) {
          showAlert("Reservation confirmed!", "success");
          setTimeout(() => location.href = "bookings.html", 1500);
        } else {
          const data = await res.json();
          showAlert(data.message || "Booking error", "error");
        }
      } catch {
        showAlert("Network error.", "error");
      }
    }

    function loadEventsFromUI() {
      loadEvents({
        date: document.getElementById('dateFilter').value,
        type: document.getElementById('typeFilter').value
      });
    }

    function showAlert(msg, type) {
      const alert = document.getElementById('alert');
      alert.textContent = msg;
      alert.className = `alert-${type}`;
      alert.style.display = 'block';
      setTimeout(() => alert.style.display = 'none', 4000);
    }

    window.onload = () => loadEvents();
  </script>
</body>

</html>